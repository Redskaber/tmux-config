# @path: ～/.config/tmux/tmux.conf
# @base: Zsh / Fish + Starship
# @datetime: 2026-01-04

# ==========================
# ===  General settings  ===
# ==========================

set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -g history-limit 20000
set -sg escape-time 0
set -g display-time 1500
set -g mouse on
set -g focus-events on

# Use C-a as prefix (like screen)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Aggressive resize for better tiling
setw -g aggressive-resize on

# Don't rename windows automatically (Starship shows context)
setw -g automatic-rename off
setw -g allow-rename off

# Set terminal title to current window name
set -g set-titles on
set -g set-titles-string "#T"

# Enable OSC 52 clipboard support (for WezTerm, Kitty, etc.)
set -g set-clipboard on

# ==========================
# ===   Key bindings     ===
# ==========================

# Reload config
bind C-r source-file ～/.config/tmux/tmux.conf \; display "Config reloaded"

# New window with current path
bind c new-window -c "#{pane_current_path}"

# Split panes with current path
bind | split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"

# Pane navigation (Vim style)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Window navigation
bind -n M-Left  previous-window
bind -n M-Right next-window
bind -n M-Tab    last-window

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Kill
bind x kill-pane
bind X kill-window

# Zoom
bind + resize-pane -Z

# Detach
bind d detach-client

# Toggle status bar
bind C-s if -F '#{==:#{status},on}' 'set status off' 'set status on'

# ================================
# === Copy mode & Clipboard    ===
# ================================

setw -g mode-keys vi

# Enter copy mode
bind -n M-Up copy-mode

# Scroll
bind -T copy-mode-vi M-Up      send-keys -X scroll-up
bind -T copy-mode-vi M-Down    send-keys -X scroll-down
bind -T copy-mode-vi PageUp    send-keys -X page-up
bind -T copy-mode-vi PageDown  send-keys -X page-down

# Mouse wheel scroll (2 lines per tick)
bind -T copy-mode-vi WheelUpPane   select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down

# --- Enhanced system clipboard support ---
# Make 'v' start selection in copy mode (Vim-like)
bind -T copy-mode-vi v send-keys -X begin-selection

# Ctrl-a v: enter visual selection directly
bind v copy-mode \; send-keys -X begin-selection

# Copy selection to system clipboard (OSC 52 + fallback)
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'sh -c " \
  if command -v wl-copy >/dev/null 2>&1; then \
    wl-copy; \
  elif command -v xclip >/dev/null 2>&1; then \
    xclip -in -selection clipboard; \
  elif command -v pbcopy >/dev/null 2>&1; then \
    pbcopy; \
  else \
    # Fallback: rely on terminal OSC 52 (WezTerm handles it)
    cat > /dev/null; \
  fi"'

# Paste from system clipboard (use Shift+P or Ctrl-a P)
is_linux="test -n \"$(command -v xsel || command -v wl-paste || command -v xclip)\""
is_mac="test -n \"$(command -v pbpaste)\""

if-shell "$is_linux" \
  'bind P run-shell "wl-paste 2>/dev/null || xsel -ob 2>/dev/null || xclip -o -selection clipboard 2>/dev/null | tmux load-buffer - && tmux paste-buffer"' \
  'if-shell "$is_mac" \
    "bind P run-shell \"pbpaste | tmux load-buffer - && tmux paste-buffer\"" \
    "bind P run-shell \"tmux paste-buffer\""'

# Standard paste (from tmux buffer)
bind p paste-buffer

# ==============================
# === Nested tmux support    ===
# ==============================

# F12: disable local keybindings to pass through to inner tmux
bind -T root F12 \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=#a0a0a0,bg=#313244" \;\
  refresh-client -S

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  refresh-client -S

# ==============================
# === Status bar (minimal)   ===
# ==============================

set -g status-position top
set -g status-interval 10
set -g status-style "fg=#cdd6f4,bg=default"

set -g status-left "#[fg=#89b4fa,bold,bg=default]#S "
set -g status-right ""

setw -g window-status-current-style "fg=#1e1e2e,bg=#89b4fa,bold"
setw -g window-status-current-format " #[fg=#1e1e2e,bg=#89b4fa,bold]#I:#W "
setw -g window-status-style "fg=#7f849c,bg=default"
setw -g window-status-format " #I:#W "

# Active pane border
setw -g pane-active-border-style "fg=#585b70"

# Inactive pane borders: make nearly invisible
setw -g pane-border-style "fg=#313244"

