# @path: ~/.config/tmux/tmux.conf
# @base: Zsh / Fish + Starship
# @philosophy: Do One Thing Well — Tmux manages sessions, not your workflow

# ==========================
# ===  General settings  ===
# ==========================

set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -g history-limit 20000
set -sg escape-time 0
set -g display-time 1500
set -g mouse on
set -g focus-events on

# Use C-a as prefix (like screen)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Aggressive resize for better tiling
setw -g aggressive-resize on

# Don't rename windows automatically (Starship shows context)
setw -g automatic-rename off
setw -g allow-rename off

# Set terminal title to current window name
set -g set-titles on
set -g set-titles-string "#T"

# Enable OSC 52 clipboard support (for WezTerm, Kitty, etc.)
set -g set-clipboard on

# ==========================
# ===   Key bindings     ===
# ==========================

# Reload config (FIXED: use ASCII ~)
bind C-r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# New window with current path
bind c new-window -c "#{pane_current_path}"

# Split panes with current path
# ps: vim -> <leader> + w , s - / v |
bind \| split-window -h -c "#{pane_current_path}"
bind _  split-window -v -c "#{pane_current_path}"

# Pane navigation (Vim style) — with both prefixed and meta keys
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Window navigation
bind -n M-Left  previous-window
bind -n M-Right next-window
bind -n M-Tab   last-window

# Resize panes (both cases for ergonomics)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Also allow lowercase with Ctrl for resizing (from first config)
bind -r C-h resize-pane -L 5
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5
bind -r C-l resize-pane -R 5

# Kill without prompt
bind x kill-pane
bind X kill-window

# Zoom toggle
bind + resize-pane -Z

# Detach
bind d detach-client

# Toggle status bar
bind C-s if -F '#{==:#{status},on}' 'set status off' 'set status on'

# ================================
# === Copy mode & Clipboard    ===
# ================================

setw -g mode-keys vi

# Enter copy mode
bind -n M-Up copy-mode

# Scroll
bind -T copy-mode-vi M-Up      send-keys -X scroll-up
bind -T copy-mode-vi M-Down    send-keys -X scroll-down
bind -T copy-mode-vi PageUp    send-keys -X page-up
bind -T copy-mode-vi PageDown  send-keys -X page-down

# Mouse wheel scroll (2 lines per tick)
bind -T copy-mode-vi WheelUpPane   select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down

# Vim-like selection and copy
# Make 'v' start selection in copy mode (Vim-like)
bind -T copy-mode-vi v send-keys -X begin-selection
# Used: copy-mode-vi v => Ctrl + v (change mode)
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# Copy selection to system clipboard
# depend: system install 'xclip' -> x11
#   bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -selection clipboard -i"
# depend: system isntall 'wl-clipboard' -> wayland
#   bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "wl-copy"
# AUTO: wl-copy -> xclip -> xsel -> pbcopy
# bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel ' \
#   if command -v wl-copy >/dev/null; then  \
#     wl-copy;                              \
#   elif command -v xclip >/dev/null; then  \
#     xclip -selection clipboard -i;        \
#   elif command -v xsel >/dev/null; then   \
#     xsel --clipboard --input;             \
#   elif command -v pbcopy >/dev/null; then \
#     pbcopy;                               \
#   else                                    \
#     true;                                 \
#   fi'
#
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "./tmux-clipboard.sh"

# Standard paste
bind p paste-buffer


# ==============================
# === Nested tmux support    ===
# ==============================

bind -T root F12 \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=#a0a0a0,bg=#313244" \;\
  refresh-client -S

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  refresh-client -S

# ==============================
# === Status bar (refined)   ===
# ==============================

set -g status-position top
set -g status-interval 10

# cdd6f4
set -g status-style "fg=#cdd6f4,bg=default"
# set -g status-style "fg=#cdd6f4,bg=#1e1e2e"

# Left: session name
set -g status-left "#[fg=#89b4fa,bold,bg=default]#S "
# set -g status-left "#[fg=#89b4fa,bold,bg=#1e1e2e] #S "

# Right: time + current window name (minimal but useful)
# Note: #W is often redundant with Starship, but kept for session-switching clarity
set -g status-right "#[fg=#89b4fa,bold,bg=default]%H:%M "
# set -g status-right "#[fg=#89b4fa,bg=#1e1e2e] %H:%M #[fg=#7f849c]#W "
# set -g status-right "#[fg=#82aaff,bg=#222436,nobold,nounderscore,noitalics]#[fg=#222436,bg=#82aaff,nobold,nounderscore,noitalics] #[fg=#c8d3f5,bg=#3a3f5a] #W #{?client_prefix,#[fg=#c099ff],#[fg=#86e1fc]}#[bg=#3a3f5a]#{?client_prefix,#[bg=#c099ff],#[bg=#86e1fc]}#[fg=#222436] #[fg=#c8d3f5,bg=#3a3f5a] #S "

# Current window: highlight with accent
setw -g window-status-current-style "fg=#1e1e2e,bg=#89b4fa,bold"
# setw -g window-status-current-format " #[fg=#1e1e2e,bg=#89b4fa,bold]#I:#(echo '#{pane_current_path}' | rev | cut -d'/' -f-2 | rev) "
# setw -g window-status-current-format "\
# #[fg=#89b4fa,bg=#1e1e2e,bold]#I:#W(\
# #[fg=#89b4fa,bg=#1e1e2e,nobold]#(echo '#{pane_current_path}' | sed 's|^$HOME|～|' | rev | cut -d'/' -f-2 | rev)\
# #[fg=#89b4fa,bg=#1e1e2e,bold])"
setw -g window-status-current-format "#[fg=#89b4fa,bg=#1e1e2e,bold]#I:#W(#[fg=#89b4fa,bg=#1e1e2e,nobold]#{b:pane_current_path}#[fg=#89b4fa,bg=#1e1e2e,bold])"

setw -g window-status-style "fg=#7f849c,bg=default"
# setw -g window-status-style "fg=#7f849c,bg=#1e1e2e"
setw -g window-status-format " #I:#W "

# Pane borders: clear but not distracting
setw -g pane-active-border-style "fg=#585b70"
# setw -g pane-active-border-style "fg=#89b4fa"
setw -g pane-border-style "fg=#313244"
# setw -g pane-border-style "fg=#45475a"

# Clock mode color (for bind t)
set -g clock-mode-colour "#89b4fa"


